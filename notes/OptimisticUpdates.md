# ä¹è§‚æ›´æ–°

â€œä¹è§‚æ›´æ–°â€è¿™ä¸ªæ¦‚å¿µåœ¨ç°ä»£åº”ç”¨å¼€å‘ï¼Œç‰¹åˆ«æ˜¯å‰ç«¯å’Œç§»åŠ¨ç«¯å¼€å‘ä¸­ æ˜¯éå¸¸æµè¡Œçš„æŠ€æœ¯æ¨¡å¼ã€‚

**ä¹è§‚æ›´æ–°** çš„æ ¸å¿ƒæ€æƒ³æ˜¯ï¼š**åœ¨å‘æœåŠ¡å™¨å‘é€è¯·æ±‚çš„åŒæ—¶ï¼Œç«‹å³åœ¨ç”¨æˆ·ç•Œé¢ä¸Šæ›´æ–°æ•°æ®ï¼Œå‡è®¾è¯·æ±‚æœ€ç»ˆä¼šæˆåŠŸã€‚** å¦‚æœä¹‹åè¯·æ±‚å¤±è´¥ï¼Œå†å›æ»š UI ä¸Šçš„æ›´æ”¹ï¼Œå¹¶å‘ŠçŸ¥ç”¨æˆ·ã€‚

è¿™å°±åƒæ˜¯â€œå…ˆæ–©åå¥â€â€”â€”å¯¹ç”¨æˆ·çš„æ“ä½œæŠ±æŒâ€œä¹è§‚â€æ€åº¦ï¼Œè®¤ä¸ºå¤§æ¦‚ç‡ä¼šæˆåŠŸï¼Œä»è€Œä¼˜å…ˆæä¾›æå¿«çš„è§†è§‰åé¦ˆã€‚

ä¸ä¹‹ç›¸å¯¹çš„æ˜¯ **æ‚²è§‚æ›´æ–°**ï¼šå…ˆå‘é€è¯·æ±‚åˆ°æœåŠ¡å™¨ï¼Œç­‰å¾…æœåŠ¡å™¨è¿”å›æˆåŠŸçš„å“åº”åï¼Œå†æ›´æ–°ç”¨æˆ·ç•Œé¢ã€‚

## ä¸€ä¸ªç®€å•çš„ä¾‹å­ï¼šç‚¹èµåŠŸèƒ½

å‡è®¾ä¸€ä¸ªç¤¾äº¤åª’ä½“çš„ç‚¹èµæŒ‰é’®ï¼š

* **æ‚²è§‚æ›´æ–°æµç¨‹ï¼š**
    1. ç”¨æˆ·ç‚¹å‡»â€œç‚¹èµâ€æŒ‰é’®ã€‚
    2. åº”ç”¨å‘æœåŠ¡å™¨å‘é€â€œç‚¹èµâ€API è¯·æ±‚ã€‚
    3. åº”ç”¨æ˜¾ç¤ºä¸€ä¸ªâ€œåŠ è½½ä¸­â€çš„æ—‹è½¬å›¾æ ‡ã€‚
    4. æœåŠ¡å™¨å¤„ç†è¯·æ±‚ï¼Œè¿”å›â€œæˆåŠŸâ€å“åº”ã€‚
    5. åº”ç”¨æ”¶åˆ°å“åº”åï¼Œå°†æŒ‰é’®å˜æˆâ€œå·²èµâ€çŠ¶æ€ï¼ˆæ¯”å¦‚å˜æˆçº¢è‰²ï¼‰ã€‚
  * **ç¼ºç‚¹ï¼š** ç”¨æˆ·ä¼šæ„ŸçŸ¥åˆ°æ˜æ˜¾çš„å»¶è¿Ÿï¼ˆä»ç‚¹å‡»åˆ°å›¾æ ‡å˜åŒ–ï¼‰ã€‚

* **ä¹è§‚æ›´æ–°æµç¨‹ï¼š**
    1. ç”¨æˆ·ç‚¹å‡»â€œç‚¹èµâ€æŒ‰é’®ã€‚
    2. **ç«‹å³**å°†æŒ‰é’®å˜æˆâ€œå·²èµâ€çŠ¶æ€ï¼Œç»™ç”¨æˆ·å³æ—¶çš„åé¦ˆã€‚
    3. **åŒæ—¶**ï¼Œåœ¨åå°å‘æœåŠ¡å™¨å‘é€â€œç‚¹èµâ€API è¯·æ±‚ã€‚
    4. **å¦‚æœè¯·æ±‚æˆåŠŸ**ï¼šçš†å¤§æ¬¢å–œï¼ŒUI çŠ¶æ€å’ŒæœåŠ¡å™¨çŠ¶æ€ä¸€è‡´ã€‚
    5. **å¦‚æœè¯·æ±‚å¤±è´¥**ï¼ˆæ¯”å¦‚ç½‘ç»œé—®é¢˜ï¼‰ï¼šåº”ç”¨å°†æŒ‰é’®**å›æ»š**åˆ°â€œæœªèµâ€çŠ¶æ€ï¼Œå¹¶å¯èƒ½æ˜¾ç¤ºä¸€ä¸ªæç¤ºï¼Œå¦‚â€œæ“ä½œå¤±è´¥ï¼Œè¯·é‡è¯•â€ã€‚
  * **ä¼˜ç‚¹ï¼š** ç”¨æˆ·ä½“éªŒæå…¶æµç•…ï¼Œæ„Ÿè§‰åº”ç”¨å“åº”é£å¿«ã€‚

## ä¹è§‚æ›´æ–°çš„æ ¸å¿ƒæ­¥éª¤

ä¸€ä¸ªå¥å£®çš„ä¹è§‚æ›´æ–°å®ç°é€šå¸¸åŒ…å«ä»¥ä¸‹æ­¥éª¤ï¼š

1. **å¿«ç…§å½“å‰çŠ¶æ€**ï¼šåœ¨æ›´æ–° UI ä¹‹å‰ï¼Œå…ˆä¿å­˜å½“å‰çš„æ•°æ®çŠ¶æ€ï¼ˆä¾‹å¦‚ï¼Œæ–‡ç« ä¹‹å‰çš„ç‚¹èµæ•°ï¼‰ã€‚è¿™æ˜¯ä¸ºäº†å›æ»šåšå‡†å¤‡ã€‚
2. **ä¹è§‚æ›´æ–° UI**ï¼šç«‹å³ç”¨â€œé¢„æœŸçš„æˆåŠŸç»“æœâ€æ¥æ›´æ–°ç”¨æˆ·ç•Œé¢ã€‚
3. **å‘é€å¼‚æ­¥è¯·æ±‚**ï¼šå‘æœåŠ¡å™¨å‘é€çœŸæ­£çš„è¯·æ±‚ã€‚
4. **å¤„ç†å“åº”**ï¼š
    * **æˆåŠŸ**ï¼šæ— éœ€é¢å¤–æ“ä½œï¼Œæˆ–è€…å¯ä»¥ silentlyï¼ˆé™é»˜åœ°ï¼‰ç”¨æœåŠ¡å™¨è¿”å›çš„æœ€æ–°æ•°æ®åŒæ­¥ä¸€ä¸‹ UIï¼ˆç¡®ä¿å®Œå…¨ä¸€è‡´ï¼‰ã€‚
    * **å¤±è´¥**ï¼š
        * **å›æ»š UI**ï¼šä½¿ç”¨ç¬¬ 1 æ­¥ä¿å­˜çš„å¿«ç…§ï¼Œå°† UI æ¢å¤åˆ°æ›´æ–°å‰çš„çŠ¶æ€ã€‚
        * **é€šçŸ¥ç”¨æˆ·**ï¼šæ¸…æ™°åœ°å‘ç”¨æˆ·å‘ŠçŸ¥é”™è¯¯ï¼Œæç¤ºä»–ä»¬æ“ä½œæœªæˆåŠŸã€‚

## ä¸ºä»€ä¹ˆè¦ä½¿ç”¨ä¹è§‚æ›´æ–°ï¼Ÿï¼ˆä¼˜ç‚¹ï¼‰

1. **å“è¶Šçš„ç”¨æˆ·ä½“éªŒ**ï¼šæ¶ˆé™¤äº†ç½‘ç»œå»¶è¿Ÿå¸¦æ¥çš„ç­‰å¾…æ„Ÿï¼Œè®©åº”ç”¨æ„Ÿè§‰ç¬é—´å“åº”ï¼Œéå¸¸â€œçˆ½æ»‘â€ã€‚
2. **æ„ŸçŸ¥æ€§èƒ½æå‡**ï¼šå³ä½¿ç”¨æˆ·çš„ç½‘ç»œå¾ˆæ…¢ï¼ŒUI çš„æ›´æ–°ä¹Ÿæ˜¯ç«‹å³çš„ï¼Œå¤§å¤§æå‡äº†åº”ç”¨çš„æ„ŸçŸ¥æ€§èƒ½ã€‚
3. **ç¬¦åˆç”¨æˆ·å¿ƒç†é¢„æœŸ**ï¼šç”¨æˆ·è¿›è¡Œæ“ä½œæ—¶æœŸæœ›ç«‹å³çœ‹åˆ°ç»“æœï¼Œä¹è§‚æ›´æ–°å®Œç¾åœ°æ»¡è¶³äº†è¿™ç§é¢„æœŸã€‚

## ä¹è§‚æ›´æ–°çš„æŒ‘æˆ˜å’Œæ³¨æ„äº‹é¡¹ï¼ˆç¼ºç‚¹ï¼‰

1. **å¤æ‚æ€§æ›´é«˜**ï¼šç›¸æ¯”æ‚²è§‚æ›´æ–°ï¼Œä½ éœ€è¦ç¼–å†™é¢å¤–çš„ä»£ç æ¥å¤„ç†å›æ»šé€»è¾‘å’Œé”™è¯¯çŠ¶æ€ã€‚
2. **å¯èƒ½çš„æ•°æ®ä¸ä¸€è‡´**ï¼šåœ¨æå°‘æ•°æƒ…å†µä¸‹ï¼Œå¦‚æœè¯·æ±‚å¤±è´¥ä¸”å›æ»šé€»è¾‘æ²¡æœ‰å¤„ç†å¥½ï¼Œå¯èƒ½ä¼šå¯¼è‡´ UI æ˜¾ç¤ºçš„çŠ¶æ€ä¸æœåŠ¡å™¨å®é™…çŠ¶æ€ä¸ä¸€è‡´ã€‚
3. **å¹¶éé€‚ç”¨äºæ‰€æœ‰åœºæ™¯**ï¼š
    * **éå¸¸é€‚åˆ**ï¼šç‚¹èµã€å…³æ³¨ã€æ”¶è—ã€æ’åºã€ç®€å•çš„è¡¨å•æäº¤ç­‰**éå…³é”®æ€§**æˆ–**å¹‚ç­‰**ï¼ˆå¤šæ¬¡æ‰§è¡Œç»“æœç›¸åŒï¼‰çš„æ“ä½œã€‚
    * **ä¸é€‚åˆ**ï¼š
        * **é‡‘èäº¤æ˜“**ï¼ˆå¦‚è½¬è´¦ï¼‰ï¼šç»å¯¹ä¸èƒ½å‡è®¾å®ƒä¼šæˆåŠŸã€‚
        * **åˆ›å»ºå…·æœ‰é‡è¦å”¯ä¸€æ€§çº¦æŸçš„æ•°æ®**ï¼ˆå¦‚æ³¨å†Œæ–°ç”¨æˆ·ï¼‰ï¼šä½ éœ€è¦ç«‹åˆ»çŸ¥é“ç”¨æˆ·åæ˜¯å¦å·²è¢«å ç”¨ã€‚
        * **é¡ºåºæ•æ„Ÿçš„æ“ä½œ**ï¼šå¦‚æœæ“ä½œé¡ºåºå¾ˆé‡è¦ï¼Œä¹è§‚æ›´æ–°å¯èƒ½ä¼šä½¿é€»è¾‘å˜å¾—å¤æ‚ã€‚

## æŠ€æœ¯å®ç°

åœ¨ç°ä»£å‰ç«¯ç”Ÿæ€ä¸­ï¼Œæœ‰è®¸å¤šå·¥å…·å¯ä»¥ç®€åŒ–ä¹è§‚æ›´æ–°çš„å®ç°ï¼š

* **React 19**ï¼šå¼•å…¥çš„ useOptimisticHook ä¸ºå®ç°ä¹è§‚æ›´æ–°æä¾›äº†å®˜æ–¹æ”¯æŒã€‚
* **React Query / TanStack Query**ï¼š æä¾›äº†å†…ç½®çš„ `onMutate`ï¼Œ `onError`ï¼Œ `onSettled` ç­‰å›è°ƒå‡½æ•°ï¼Œå¯ä»¥éå¸¸æ–¹ä¾¿åœ°å®ç°ä¹è§‚æ›´æ–°ã€‚
* **SWR**ï¼š å¯ä»¥é€šè¿‡ `mutate` å‡½æ•°æ‰‹åŠ¨æ§åˆ¶ç¼“å­˜ï¼Œç»“åˆ `optimisticData` é€‰é¡¹å®ç°ä¹è§‚æ›´æ–°ã€‚
* **Redux**ï¼š å¯ä»¥é…åˆåƒ `Redux Toolkit` çš„ `createAsyncThunk` æˆ–åœ¨ `extraReducers` ä¸­æ‰‹åŠ¨ç®¡ç†â€œpendingâ€, â€œfulfilledâ€, â€œrejectedâ€ çŠ¶æ€æ¥å®ç°ã€‚

### useOptimistic å®ç°

ä¸‹é¢ä»¥ useOptimistic ä¸ºä¾‹ï¼Œä»‹ç»å¦‚ä½•ä½¿ç”¨ useOptimistic å®ç°ç‚¹èµåŠŸèƒ½çš„ä¹è§‚æ›´æ–°ã€‚

useOptimisticå…è®¸ä½ åœ¨å¼‚æ­¥æ“ä½œï¼ˆå¦‚ç½‘ç»œè¯·æ±‚ï¼‰å®é™…å®Œæˆâ€‹â€‹ä¹‹å‰â€‹â€‹ï¼Œå°±â€œä¹è§‚åœ°â€æ›´æ–°ç”¨æˆ·ç•Œé¢ï¼Œå‡è®¾æ“ä½œä¼šæˆåŠŸã€‚å¦‚æœæœ€ç»ˆæ“ä½œå¤±è´¥ï¼Œç•Œé¢ä¼šè‡ªåŠ¨å›æ»šåˆ°æ›´æ–°å‰çš„çŠ¶æ€ã€‚å…¶åŸºæœ¬è¯­æ³•å¦‚ä¸‹ï¼š

```ts
const [optimisticState, addOptimistic] = useOptimistic(state, updateFn);
```

* `state`: å½“å‰çš„å®é™…çŠ¶æ€ã€‚
* `updateFn`: ä¸€ä¸ªå‡½æ•°ï¼Œæ ¼å¼ä¸º `(currentState, optimisticValue) => newState`ã€‚å®ƒå®šä¹‰äº†å¦‚ä½•æ ¹æ®â€œä¹è§‚å€¼â€ç”Ÿæˆæ–°çš„ä¹è§‚çŠ¶æ€ã€‚
* è¿”å›å€¼ï¼š
  * `optimisticState`: å½“å‰åº”æ˜¾ç¤ºçš„ä¹è§‚çŠ¶æ€ã€‚æ— ä¹è§‚æ›´æ–°æ—¶ç­‰äº `state`ï¼Œæœ‰ä¹è§‚æ›´æ–°æ—¶æ˜¯ `updateFn` çš„ç»“æœã€‚
  * `addOptimistic`: è§¦å‘ä¹è§‚æ›´æ–°çš„å‡½æ•°ï¼Œè°ƒç”¨æ—¶ä¼šä¼ å…¥ `optimisticValue`ã€‚

#### ğŸ› ï¸ æ ¸å¿ƒå®ç°æ­¥éª¤

ä¸€ä¸ªå®Œæ•´çš„ä¹è§‚æ›´æ–°æµç¨‹é€šå¸¸åŒ…æ‹¬ä»¥ä¸‹æ­¥éª¤ï¼š

1. **è§¦å‘æ›´æ–°**ï¼šç”¨æˆ·è¿›è¡Œæ“ä½œï¼ˆå¦‚ç‚¹å‡»æŒ‰é’®ï¼‰ã€‚
2. **ä¹è§‚æ›´æ–°UI**ï¼šç«‹å³è°ƒç”¨ `addOptimistic` å‡½æ•°ï¼Œä¼ å…¥æ–°æ•°æ®ã€‚ç•Œé¢ä¼šåŸºäº `updateFn` å¿«é€Ÿæ˜¾ç¤ºé¢„æœŸç»“æœã€‚
3. **æ‰§è¡Œå¼‚æ­¥æ“ä½œ**ï¼šå‘é€å®é™…çš„æ•°æ®è¯·æ±‚ï¼ˆå¦‚ `fetch`ï¼‰ã€‚
4. **å¤„ç†æœ€ç»ˆç»“æœ**ï¼š
    * **æˆåŠŸ**ï¼šé€šå¸¸éœ€è¦æ›´æ–°å®é™…çš„çŠ¶æ€ï¼ˆå¦‚é€šè¿‡ `setState`ï¼‰ï¼Œä½¿ä¹è§‚çŠ¶æ€ä¸åç«¯æ•°æ®åŒæ­¥ã€‚
    * **å¤±è´¥**ï¼šåœ¨è¯·æ±‚å¤±è´¥æ—¶ï¼Œéœ€è¦**æ‰‹åŠ¨æ•è·é”™è¯¯å¹¶å›æ»šçŠ¶æ€**ã€‚`useOptimistic` æœ¬èº«ä¸è‡ªåŠ¨å¤„ç†è¯·æ±‚å¤±è´¥çš„å›æ»šï¼Œè¿™éœ€è¦å¼€å‘è€…å®ç°ã€‚

ç‚¹å‡»ç‚¹èµåç«‹å³å¢åŠ æ•°å­—ï¼Œæ— éœ€ç­‰å¾…ç½‘ç»œè¯·æ±‚ã€‚

```ts
function LikeButton({ id, initialLikes }) {
  const [likes, setLikes] = useState(initialLikes);
  // å®šä¹‰ä¹è§‚æ›´æ–°ï¼šå½“å‰ç‚¹èµæ•° + ä¼ å…¥çš„å¢é‡
  const [optimisticLikes, addOptimisticLike] = useOptimistic(
    likes,
    (currentLikes, addedLikes) => currentLikes + addedLikes
  );

  async function handleLike() {
    // 1. ç«‹å³ä¹è§‚æ›´æ–°UI
    addOptimisticLike(1);
    try {
      // 2. æ‰§è¡Œå¼‚æ­¥æ“ä½œ
      const response = await fetch(`/api/like/${id}`, { method: 'POST' });
      const newLikes = await response.json();
      // 3. æˆåŠŸï¼šæ›´æ–°å®é™…çŠ¶æ€
      setLikes(newLikes);
    } catch (error) {
      // 4. å¤±è´¥ï¼šå›æ»šå®é™…çŠ¶æ€ï¼Œç•Œé¢ä¹Ÿä¼šç›¸åº”å›é€€
      // 5. æ¸…æ™°åœ°å‘ç”¨æˆ·å‘ŠçŸ¥é”™è¯¯ï¼Œæç¤ºä»–ä»¬æ“ä½œæœªæˆåŠŸ
      setLikes(likes);
    }
  }

  return (
    <button onClick={handleLike}>
      Likes: {optimisticLikes} {/* å§‹ç»ˆæ˜¾ç¤ºä¹è§‚çŠ¶æ€ */}
    </button>
  );
}
```

## æ€»ç»“

**ä¹è§‚æ›´æ–°**æ˜¯ä¸€ç§é€šè¿‡â€œå‡è®¾æˆåŠŸï¼Œå¿«é€Ÿå“åº”ï¼Œå¤±è´¥å›æ»šâ€æ¥æå¤§æå‡ç”¨æˆ·ä½“éªŒçš„è®¾è®¡æ¨¡å¼ã€‚å®ƒç”¨ä¸€å®šçš„å®ç°å¤æ‚æ€§æ¢å–äº†æµç•…åº¦å’Œç”¨æˆ·æ»¡æ„åº¦ã€‚åœ¨æ„å»ºç°ä»£ã€äº¤äº’æ€§å¼ºçš„ Web æˆ–ç§»åŠ¨åº”ç”¨æ—¶ï¼Œå¯¹äºåˆé€‚çš„åœºæ™¯ï¼Œå®ƒæ˜¯ä¸€ä¸ªéå¸¸å€¼å¾—é‡‡ç”¨çš„æœ€ä½³å®è·µã€‚
